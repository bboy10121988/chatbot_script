<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Chatbot Embed 測試</title>
    <style>
      body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, 'Noto Sans', 'PingFang TC', 'Microsoft JhengHei', sans-serif; margin: 32px; }
    </style>
  </head>
  <body>
    <div id="deploy_info" style="position:fixed;top:8px;right:12px;background:#eef2ff;color:#111827;border:1px solid #e5e7eb;padding:6px 10px;border-radius:8px;font-size:12px;z-index:10000;">
      部署更新：<span id="deploy_ts"></span>
    </div>
    <h1>Chatbot 管理介面</h1>
    <p>在此頁面設定「歡迎提示」、「預設回覆」，以及管理「關鍵字觸發規則」。右下角仍可透過浮窗驗證效果。</p>

    <section>
      <h2>全域設定</h2>
      <div style="max-width:640px;display:flex;flex-direction:column;gap:8px">
        <label>歡迎提示<br/>
          <textarea id="welcome_text" rows="3" style="width:100%"></textarea>
        </label>
        <label>預設回覆（無命中或兜底時）<br/>
          <textarea id="default_reply_text" rows="2" style="width:100%"></textarea>
        </label>
        <div>
          <button id="save_settings">保存設定</button>
          <span id="settings_status" style="margin-left:8px;color:#059669"></span>
          <button id="reset_conv" style="margin-left:12px">重設對話</button>
          <span id="reset_status" style="margin-left:8px;color:#2563eb"></span>
        </div>
      </div>
    </section>

    <hr/>
    <section>
      <h2>商品資料（本地庫）與外部 API 設定</h2>
      <div style="margin-bottom:12px;max-width:820px;display:flex;flex-direction:column;gap:6px">
        <label>外部商品 API URL（GET，回傳 JSON 陣列）<br/>
          <input id="ext_api_url" placeholder="例如：https://shop.example.com/api/products" style="width:100%"/>
        </label>
        <label>外部 API Key（可選，用於 Authorization: Bearer）<br/>
          <input id="ext_api_key" placeholder="例如：xxxxx" style="width:100%"/>
        </label>
        <div>
          <button id="save_ext">保存 API 設定</button>
          <button id="import_ext" style="margin-left:8px">從外部 API 載入</button>
          <span id="ext_status" style="margin-left:8px;color:#059669"></span>
        </div>
      </div>

      <div style="margin:6px 0">
        <button id="refresh_products">重新整理商品列表</button>
      </div>
      <table id="products_table" border="1" cellspacing="0" cellpadding="6" style="border-color:#e5e7eb;min-width:900px">
        <thead>
          <tr><th>ID</th><th>SKU</th><th>名稱</th><th>價格</th><th>幣別</th><th>庫存</th><th>啟用</th><th>操作</th></tr>
        </thead>
        <tbody></tbody>
      </table>
      <div id="products_status" style="margin-top:8px;color:#059669"></div>
    </section>

    <hr/>
    <section>
      <h2>關鍵字規則</h2>
      <div style="margin-bottom:12px">
        <input id="new_trigger" placeholder="觸發詞（例如：藍牙耳機）" style="width:220px"/>
        <select id="new_match">
          <option value="contains">包含</option>
          <option value="exact">精確</option>
          <option value="prefix">前綴</option>
          <option value="regex">正則</option>
        </select>
        <input id="new_priority" placeholder="優先級（數字，越大越先）" style="width:180px"/>
        <input id="new_product_ids" placeholder="商品ID逗號分隔（例如：1,2,3）" style="width:240px"/>
        <input id="new_response" placeholder="回覆文案（可選）" style="width:260px"/>
        <button id="add_rule">新增規則</button>
      </div>
      <table id="rules_table" border="1" cellspacing="0" cellpadding="6" style="border-color:#e5e7eb">
        <thead>
          <tr><th>ID</th><th>觸發詞</th><th>匹配</th><th>優先級</th><th>商品IDs</th><th>回覆文案</th><th>啟用</th><th>操作</th></tr>
        </thead>
        <tbody></tbody>
      </table>
      <div id="rules_status" style="margin-top:8px;color:#059669"></div>
    </section>

    <script>
      function getParam(name){ try{ const u=new URL(window.location.href); return u.searchParams.get(name); }catch(e){ return null; } }
      let API_BASE = localStorage.getItem('API_BASE') || getParam('api_base') || 'https://chatbotscript-production.up.railway.app/v1';
      let API_KEY  = localStorage.getItem('API_KEY')  || getParam('api_key')  || 'demo_key';
      function saveApiConfig(base, key){
        const normalized = base.replace(/\/$/, '');
        API_BASE = /\/v1$/.test(normalized) ? normalized : (normalized + '/v1');
        API_KEY = key;
        localStorage.setItem('API_BASE', API_BASE);
        localStorage.setItem('API_KEY', API_KEY);
      }

      async function fetchSettings(){
        const res = await fetch(API_BASE+'/settings',{headers:{'X-API-Key':API_KEY}});
        const data = await res.json();
        document.getElementById('welcome_text').value = data.welcome_text || '';
        document.getElementById('default_reply_text').value = data.default_reply_text || '';
        document.getElementById('ext_api_url').value = data.external_products_api_url || '';
        document.getElementById('ext_api_key').value = data.external_products_api_key || '';
        const ab = document.getElementById('api_base'); if (ab) ab.value = API_BASE.replace(/\/v1$/, '');
        const ak = document.getElementById('api_key'); if (ak) ak.value = API_KEY;
      }

      async function saveSettings(){
        const body = {
          welcome_text: document.getElementById('welcome_text').value,
          default_reply_text: document.getElementById('default_reply_text').value,
          external_products_api_url: document.getElementById('ext_api_url').value,
          external_products_api_key: document.getElementById('ext_api_key').value,
        };
        const res = await fetch(API_BASE+'/settings',{method:'PUT',headers:{'Content-Type':'application/json','X-API-Key':API_KEY},body:JSON.stringify(body)});
        if(res.ok){ document.getElementById('settings_status').textContent='已保存'; setTimeout(()=>document.getElementById('settings_status').textContent='',1500); }
      }

      async function importExt(){
        const res = await fetch(API_BASE+'/admin/products/import',{method:'POST',headers:{'Content-Type':'application/json','X-API-Key':API_KEY},body:JSON.stringify({})});
        if(res.ok){ const d = await res.json(); document.getElementById('ext_status').textContent = `已載入：新增 ${d.created} 筆，更新 ${d.updated} 筆`; fetchProducts(); setTimeout(()=>document.getElementById('ext_status').textContent='',2500); }
        else{ document.getElementById('ext_status').textContent='載入失敗'; setTimeout(()=>document.getElementById('ext_status').textContent='',2500); }
      }

      async function fetchProducts(){
        const res = await fetch(API_BASE+'/admin/products?limit=200',{headers:{'X-API-Key':API_KEY}});
        const list = await res.json();
        const tbody = document.querySelector('#products_table tbody');
        tbody.innerHTML='';
        list.forEach(p=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${p.id}</td>
            <td contenteditable data-k="sku">${p.sku||''}</td>
            <td contenteditable data-k="name">${p.name||''}</td>
            <td contenteditable data-k="price">${p.price||0}</td>
            <td contenteditable data-k="currency">${p.currency||'CNY'}</td>
            <td contenteditable data-k="stock">${p.stock||0}</td>
            <td contenteditable data-k="is_active">${p.is_active?1:0}</td>
            <td>
              <button data-act="save">保存</button>
              <button data-act="delete">刪除</button>
            </td>`;
          tr.querySelector('[data-act="save"]').onclick = async ()=>{
            const payload = {};
            tr.querySelectorAll('[data-k]').forEach(cell=>{
              const k = cell.getAttribute('data-k');
              let v = cell.textContent.trim();
              if(k==='price') v = parseFloat(v||'0');
              if(k==='stock') v = parseInt(v||'0');
              if(k==='is_active') v = v==='1' || v.toLowerCase()==='true';
              payload[k] = v;
            });
            await fetch(API_BASE+'/admin/products/'+p.id,{method:'PUT',headers:{'Content-Type':'application/json','X-API-Key':API_KEY},body:JSON.stringify(payload)});
            document.getElementById('products_status').textContent='已保存'; setTimeout(()=>document.getElementById('products_status').textContent='',1500);
          };
          tr.querySelector('[data-act="delete"]').onclick = async ()=>{
            await fetch(API_BASE+'/admin/products/'+p.id,{method:'DELETE',headers:{'X-API-Key':API_KEY}});
            fetchProducts();
          };
          tbody.appendChild(tr);
        });
      }

      async function fetchRules(){
        const res = await fetch(API_BASE+'/keyword-rules',{headers:{'X-API-Key':API_KEY}});
        const list = await res.json();
        const tbody = document.querySelector('#rules_table tbody');
        tbody.innerHTML='';
        list.forEach(r=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${r.id}</td>
            <td contenteditable data-k="trigger_text">${r.trigger_text||''}</td>
            <td contenteditable data-k="match_type">${r.match_type||'contains'}</td>
            <td contenteditable data-k="priority">${r.priority||0}</td>
            <td contenteditable data-k="product_ids">${(r.product_ids||[]).join(',')}</td>
            <td contenteditable data-k="response_text">${r.response_text||''}</td>
            <td contenteditable data-k="is_active">${r.is_active?1:0}</td>
            <td>
              <button data-act="save">保存</button>
              <button data-act="delete">刪除</button>
            </td>`;
          tr.querySelector('[data-act="save"]').onclick = async ()=>{
            const payload = {};
            tr.querySelectorAll('[data-k]').forEach(cell=>{
              const k = cell.getAttribute('data-k');
              let v = cell.textContent.trim();
              if(k==='priority') v = parseInt(v||'0');
              if(k==='is_active') v = v==='1' || v.toLowerCase()==='true';
              if(k==='product_ids') v = v? v.split(',').map(x=>parseInt(x.trim())).filter(x=>!isNaN(x)) : [];
              payload[k] = v;
            });
            await fetch(API_BASE+'/keyword-rules/'+r.id,{method:'PUT',headers:{'Content-Type':'application/json','X-API-Key':API_KEY},body:JSON.stringify(payload)});
            document.getElementById('rules_status').textContent='已保存'; setTimeout(()=>document.getElementById('rules_status').textContent='',1500);
          };
          tr.querySelector('[data-act="delete"]').onclick = async ()=>{
            await fetch(API_BASE+'/keyword-rules/'+r.id,{method:'DELETE',headers:{'X-API-Key':API_KEY}});
            fetchRules();
          };
          tbody.appendChild(tr);
        });
      }

      async function addRule(){
        const body = {
          trigger_text: document.getElementById('new_trigger').value.trim(),
          match_type: document.getElementById('new_match').value,
          priority: parseInt(document.getElementById('new_priority').value||'0'),
          product_ids: (document.getElementById('new_product_ids').value||'').split(',').map(x=>parseInt(x.trim())).filter(x=>!isNaN(x)),
          response_text: document.getElementById('new_response').value,
          is_active: true,
        };
        if(!body.trigger_text){ alert('觸發詞必填'); return; }
        await fetch(API_BASE+'/keyword-rules',{method:'POST',headers:{'Content-Type':'application/json','X-API-Key':API_KEY},body:JSON.stringify(body)});
        document.getElementById('new_trigger').value='';
        document.getElementById('new_priority').value='';
        document.getElementById('new_product_ids').value='';
        document.getElementById('new_response').value='';
        fetchRules();
      }

      document.getElementById('save_settings').onclick = saveSettings;
      document.getElementById('reset_conv').onclick = function(){
        if (window.ChatbotEmbedReset){ window.ChatbotEmbedReset(); document.getElementById('reset_status').textContent='已重設（請打開對話窗查看歡迎詞）'; setTimeout(()=>document.getElementById('reset_status').textContent='', 1800); }
        else { alert('嵌入腳本尚未載入'); }
      };
      document.getElementById('save_ext').onclick = saveSettings;
      document.getElementById('import_ext').onclick = importExt;
      document.getElementById('refresh_products').onclick = fetchProducts;
      document.getElementById('add_rule').onclick = addRule;
      fetchSettings();
      fetchProducts();
      fetchRules();
    </script>

    <!-- 仍可用浮窗驗證效果（改為動態注入，跟隨 API_BASE / API_KEY） -->
    <script>
      function loadEmbed(){
        try{
          window.CHATBOT_API_BASE = API_BASE;
          window.CHATBOT_API_KEY = API_KEY;
          const old = document.getElementById('embed_script'); if (old) old.remove();
          const origin = new URL(API_BASE).origin;
          const s = document.createElement('script'); s.id='embed_script'; s.src = origin + '/embed.js'; document.body.appendChild(s);
        }catch(e){ console.error('Failed to load embed.js', e); }
      }
      async function testConnection(){
        const statusEl = document.getElementById('api_test_status');
        const baseInput = document.getElementById('api_base');
        const base = (baseInput && baseInput.value.trim()) ? baseInput.value.trim() : API_BASE.replace(/\/v1$/, '');
        if(!base){ statusEl.style.color = '#dc2626'; statusEl.textContent = '請先填 API Base'; return; }
        // normalize and persist
        saveApiConfig(base, document.getElementById('api_key') ? document.getElementById('api_key').value.trim() : API_KEY);
        statusEl.textContent = '測試中...'; statusEl.style.color = '#2563eb';
        let origin;
        try{ origin = new URL(API_BASE).origin; } catch(e){ statusEl.style.color='#dc2626'; statusEl.textContent='API Base 非法'; return; }
        let healthOK = false, settingsOK = false, settingsMsg = '';
        try{
          const h = await fetch(origin + '/health');
          healthOK = h.ok;
        }catch(e){ healthOK = false; }
        try{
          const s = await fetch(API_BASE + '/settings', { headers: { 'X-API-Key': API_KEY }});
          settingsOK = s.ok;
          if(!s.ok){ settingsMsg = 'HTTP ' + s.status; } else { const j = await s.json(); settingsMsg = 'OK'; }
        }catch(e){ settingsOK = false; settingsMsg = 'Network/CORS'; }
        if(healthOK && settingsOK){ statusEl.style.color = '#059669'; statusEl.textContent = '連線成功（/health OK, /v1/settings OK）'; }
        else { statusEl.style.color = '#dc2626'; statusEl.textContent = `連線失敗（health: ${healthOK?'OK':'NG'}, settings: ${settingsOK?'OK':'NG'} ${settingsMsg})`; }
      }
      (function addApiControls(){
        const sec = document.createElement('section');
        sec.innerHTML = '<h2>API 設定</h2>\
          <div style="max-width:640px;display:flex;flex-direction:column;gap:8px">\
            <label>API Base（例如：https://your-railway-host）<br/><input id="api_base" style="width:100%"/></label>\
            <label>API Key（站點金鑰）<br/><input id="api_key" style="width:100%"/></label>\
            <div>\
              <button id="save_api">保存 API 設定並重新載入浮窗</button>\
              <button id="test_api" style="margin-left:8px">測試後端連線</button>\
              <span id="api_status" style="margin-left:8px;color:#059669"></span>\
              <span id="api_test_status" style="margin-left:8px;color:#2563eb"></span>\
            </div>\
          </div>';
        const anchor = document.querySelector('h1');
        if(anchor && anchor.parentNode){ anchor.parentNode.insertBefore(sec, anchor.nextSibling); } else { document.body.insertBefore(sec, document.body.firstChild); }
        // Prefill inputs immediately with current config
        const ab = document.getElementById('api_base'); if (ab) ab.value = API_BASE.replace(/\/v1$/, '');
        const ak = document.getElementById('api_key'); if (ak) ak.value = API_KEY;
        document.getElementById('save_api').onclick = function(){
          const base = document.getElementById('api_base').value.trim();
          const key  = document.getElementById('api_key').value.trim();
          if(!base){ alert('請填 API Base'); return; }
          saveApiConfig(base, key);
          loadEmbed();
          const st = document.getElementById('api_status'); st.textContent='已保存'; setTimeout(()=>st.textContent='',1500);
        };
        document.getElementById('test_api').onclick = testConnection;
      })();
      // Show deploy/build time (to milliseconds) from document.lastModified
      try{
        const ts = new Date(document.lastModified);
        const pad = n => n.toString().padStart(2,'0');
        const ms = ts.getMilliseconds().toString().padStart(3,'0');
        const local = `${ts.getFullYear()}-${pad(ts.getMonth()+1)}-${pad(ts.getDate())} ${pad(ts.getHours())}:${pad(ts.getMinutes())}:${pad(ts.getSeconds())}.${ms}`;
        document.getElementById('deploy_ts').textContent = local;
      }catch(e){}
      loadEmbed();
    </script>
  </body>
  </html>
